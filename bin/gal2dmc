#!/usr/bin/python
# Compile .gal files into .dmc for use on a Galil Controller
#
# Author: Dean Serenevy  <deans@apcisystems.com>
# This software is Copyright (c) 2013 APCI, LLC. All rights reserved.
from __future__ import division, absolute_import, print_function

import sys
from os.path import split, join, dirname, abspath, isfile, isdir, basename, exists
sys.path.insert(1, "pylib")
sys.path.insert(1, join(dirname(dirname(abspath(__file__))), "pylib"))

import re

import apci
import logging
apci.save_logs("gal2dmc")
logger = logging.getLogger('apci.gal2dmc')

from apci.galil.file import GalilFile
from apci.lfw.machine import Machine
from apci.paths import user_conf


import argparse
def getopts():
    parser = argparse.ArgumentParser(description="""
compile .gal file into a .dmc

Generates files ready for use in galiltools. The general convention used is
that ".gal" files are template files which can use indenting and arbitrary
comments. These ".gal" files should be compiled into ".dmc" files which
will fill in template variables, remove offensive space and optionally
perform minification to help stay within line limits.
"""
)

    default_vars = user_conf("lfw/machine.json") if exists(user_conf("lfw/machine.json")) else None

    parser.add_argument('--output', '-o', help='output file or directory for compiled files (default STDOUT)')
    parser.add_argument('--vars', '-v', help='machine definition file', default=default_vars)
    parser.add_argument('--minify', '-m', action='store_true', help='enable minification')
    parser.add_argument('--no-trim', '-t', action='store_true', help='show (do not trim) whitespace')
    parser.add_argument('--default', action='store_true', help='load default config without raising warning')

    parser.add_argument('file', type=str, nargs='+', help='files to compile')
    return parser.parse_args()


def MAIN(argv):
    for f in argv.file:
        # Build template
        (path, fname) = split(f)
        gf = GalilFile(path if len(path) else ".")

        # Load Variables
        if argv.vars:
            machine = Machine.load(argv.vars)
        elif isfile("machine.json"):
            machine = Machine.load("machine.json")
        else:
            if not argv.default:
                logger.warning('Loading Default Machine Definition')
            machine = Machine()

        # Validate!
        machine.validate()

        # Process Templates
        if argv.minify:
            dmc = gf.load(fname, machine)
        elif argv.no_trim:
            dmc = gf.render(fname, machine)
        else:
            dmc = gf.trim(gf.render(fname, machine))

        for err in gf.lint(dmc, warnings=True):
            logger.warning(err)

        # Write out results
        if not argv.output or '-' == argv.output:
            print(dmc)
        else:
            fout = get_output(f, argv.output)
            open(fout, "w").write(dmc + "\n")



def get_output(source, target):
    fout = re.sub(r'\.gal', '.dmc', basename(source))
    if fout == basename(source) or not re.match(r'\.dmc', fout):
        fout += '.dmc'

    if target and isdir(target):
        return join(target, fout)

    elif target:
        return target

    else:
        return join(dirname(source), fout)



if __name__ == '__main__':
    MAIN(getopts())
